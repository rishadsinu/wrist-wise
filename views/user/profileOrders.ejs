<%- include ('../layouts/header.ejs') %>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <style>
        .table {
            border-collapse: separate;
            border-spacing: 0;
            width: 80%;
            max-width: 100%;
            margin-bottom: 1rem;
            background-color: transparent;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .table th,
        .table td {
            padding: 1rem;
            vertical-align: middle;
            text-align: center;
        }

        .table thead th {
            background-color: #343a40;
            color: white;
            text-transform: uppercase;
            font-weight: bold;
            border: none;
            padding: 1.5rem;
        }

        .table tbody tr {
            transition: all 0.3s ease-in-out;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .table td {
            font-size: 1.3rem;
            border-top: 1px solid #dee2e6;
        }

        .badge-primary {
            background-color: #ffffff;
            color: rgb(31, 45, 33);
            font-size: 1.2rem;
            padding: 0.4em 0.6em;
            border-radius: 12px;
        }

        .text-success {
            font-weight: bold;
        }

        .table td .btn-primary {
            background-color: #ffffff;
            border-color: #ffffff;
            color: rgb(0, 0, 0);
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            transition: background-color 0.3s ease;
        }

        .table td .btn-primary:hover {
            background-color: #ffffff;
            border-color: #004085;
        }

        .table td .fas {
            font-size: 1.3rem;
        }



        .modal-body .card {
            margin-bottom: 1rem;
        }

        .modal-body .table-invoice {
            margin-bottom: 0;
        }

        .modal-body .total-row {
            font-weight: bold;
        }

        .modal-content {
            width: 775px;
        }
    </style>

    <div class="page-wrapper">
        <header class="header">

            <div class="header-top">
                <div class="container">
                    <div class="header-left col-lg-7">
                        <nav aria-label="breadcrumb" class="breadcrumb-nav border-0 mb-0">
                            <div class="container breadcrumbs">
                                <ol class="breadcrumb">
                                    <!-- Breadcrumbs with links -->
                                    <li class="breadcrumb-item">
                                        <% if (user) { %>
                                    <li>
                                        <a href="userprofile"><i class="icon-user"></i>
                                            <%= user.name || user.displayName %>
                                        </a>
                                    </li>
                                    <% } else { %>
                                        <li>
                                            <a href="/login"><i class="icon-user"></i>Login</a>
                                        </li>
                                        <% } %>
                                            </li>


                                </ol>
                            </div>
                            <!-- End .container -->
                        </nav>
                        <!-- End .breadcrumb-nav -->
                    </div>

                    <!-- End .header-right -->
                </div>
                <!-- End .container -->

            </div>

            <div class="header-bottom sticky-header">
                <div class="container">
                    <div class="header-left">
                        <button class="mobile-menu-toggler">
                            <span class="sr-only">Toggle mobile menu</span>
                            <i class="icon-bars"></i>
                        </button>


                        <img src="/images/ww logo black.jpg" alt="Molla Logo"
                            style="width:72px; height:62px; cursor:pointer;">

                    </div>
                    <div class="header-center">
                        <nav class="main-nav">
                            <ul class="menu sf-arrows">
                                <li>
                                    <a href="/home" class="sf-with-ul">Home</a>


                                </li>
                                <li>
                                    <a href="category" class="sf-with-ul">Shoping</a>


                                </li>

                                <li>
                                    <a href="#" class="sf-with-ul">Pages</a>

                                    <ul>
                                        <li>
                                            <a href="/aboutus">About Us</a>

                                        </li>
                                        <li>
                                            <a href="/aboutus">Contact Us</a>

                                        </li>
                                        <li><a href="/category">Shoping</a></li>
                                        <li><a href="/userprofile">My Account</a></li>
                                        <li><a href="/profileOrders">My Orders</a></li>
                                        <li><a href="/wallet">My Wallet</a></li>
                                        <li><a href="/cart">Cart</a></li>
                                        <li><a href="/wishlist">Wishlist</a></li>
                                        <li><a href="/login">Login</a></li>
                                    </ul>
                                </li>


                            </ul><!-- End .menu -->
                        </nav><!-- End .main-nav -->
                    </div><!-- End .header-left -->

                    <div class="header-right">


                        <a href="wishlist" class="wishlist-link">
                            <i class="icon-heart-o"></i>

                        </a>

                        <div class="dropdown cart-dropdown">
                            <a href="/cart" class="dropdown-toggle" role="button">
                                <i class="icon-shopping-cart"></i>
                            </a>
                        </div>
                    </div><!-- End .header-right -->
                </div><!-- End .container -->
            </div><!-- End .header-bottom -->
        </header><!-- End .header -->

        <main class="main">
            <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
                <div class="container">
                    <h1 class="page-title">My Account<span>Shop</span></h1>
                </div><!-- End .container -->
            </div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/home">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">My Account</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
                <div class="dashboard">
                    <div class="container">
                        <div class="row">
                            <aside class="col-md-4 col-lg-3">
                                <ul class="nav nav-dashboard flex-column mb-3 mb-md-0" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link" href="userprofile" role="tab">Account Details</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link active" href="/profileOrders"
                                            role="tab" >Orders</a>
                                    </li>

                                    <li class="nav-item"></li>
                                        <a class="nav-link" href="/wallet"
                                            role="tab" >Wallet</a>
                                    </li>
                                   
                                    <li class="nav-item">
                                        <a class="nav-link" href="/profileAddress"
                                            role="tab" >Adresses</a>
                                    </li>
                                   
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" id="logoutLink">Sign Out</a>
                                    </li>
                                    
                                </ul>
                            </aside>



                            <div class="col-md-8 col-lg-9">
                                <div class="tab-content">


                                    <div class="tab-pane fade show active" id="tab-dashboard" role="tabpanel"
                                        aria-labelledby="tab-dashboard-link">
                                        <% if (orders && orders.length> 0) { %>
                                            <div class="container">
                                                <div class="table-responsive">
                                                    <table class="table table-hover table-bordered">
                                                        <thead class="thead-dark">
                                                            <tr>
                                                                <th scope="col">Image</th>
                                                                <th scope="col">Order ID</th>
                                                                <th scope="col">Order Date</th>
                                                                <th scope="col">Status</th>
                                                                <th scope="col">Details</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>

                                                            <% orders.forEach(order=> { %>
                                                                <tr>
                                                                    <td>
                                                                        <% if (order.productImages &&
                                                                            order.productImages.length> 0) { %>
                                                                            <img src="/images/<%= order.productImages[0] %>"
                                                                                alt="Product Image"
                                                                                style="width: 50px; height: 50px; object-fit: cover; margin-left: 29px;">
                                                                            <% } else { %>
                                                                                <img src="/images/placeholder.jpg"
                                                                                    alt="No Image Available"
                                                                                    style="width: 50px; height: 50px; object-fit: cover;">
                                                                                <% } %>
                                                                    </td>
                                                                    <td><strong>#<%= order.orderId %></strong></td>
                                                                    <td>
                                                                        <%= new
                                                                            Date(order.createdAt).toLocaleDateString()
                                                                            %>
                                                                    </td>
                                                                    <td><span class="badge badge-primary">
                                                                            <%= order.status %>
                                                                        </span></td>
                                                                    <td>
                                                                        <button type="button"
                                                                            class="btn btn-primary btn-sm view-order-btn"
                                                                            data-toggle="modal"
                                                                            data-target="#orderModal"
                                                                            data-order-id="<%= order._id %>">
                                                                            View <i class="fas fa-eye"></i>
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                                <% }); %>


                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <% } else { %>
                                                <div class="container">
                                                    <div class="alert alert-info" role="alert">
                                                        <i class="fas fa-info-circle"></i> You have no orders yet.
                                                    </div>
                                                </div>
                                                <% } %>
                                    </div>

                                </div>
                                <!-- pagination -->
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                            <a class="page-link page-link-prev" href="?page=<%= currentPage - 1 %>"
                                                aria-label="Previous" tabindex="-1">
                                                <span aria-hidden="true"><i class="icon-long-arrow-left"></i></span>Prev
                                            </a>
                                        </li>

                                        <% for (let i=1; i <=totalPages; i++) { %>
                                            <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                                <a class="page-link" href="?page=<%= i %>">
                                                    <%= i %>
                                                </a>
                                            </li>
                                            <% } %>

                                                <li
                                                    class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                                    <a class="page-link page-link-next"
                                                        href="?page=<%= currentPage + 1 %>" aria-label="Next">
                                                        Next <span aria-hidden="true"><i
                                                                class="icon-long-arrow-right"></i></span>
                                                    </a>
                                                </li>
                                    </ul>
                                </nav>
                            </div>


                        </div><!-- End .row -->
                    </div><!-- End .container -->
                </div><!-- End .dashboard -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->


        <!-- Order Details Modal -->
        <div class="modal fade" id="orderModal" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="orderModalLabel">Order Details</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Order details will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancellation Reason Modal -->
        <div class="modal fade" id="cancelItemModal" tabindex="-1" role="dialog" aria-labelledby="cancelItemModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="cancelItemModalLabel"><i class="fas fa-times-circle"></i> Cancel
                            Item</h5>
                        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="cancelItemForm">
                            <div class="form-group">
                                <label for="cancelReason" class="font-weight-bold">Reason for cancellation:</label>
                                <textarea class="form-control border-danger" id="cancelReason" rows="4"
                                    placeholder="Please provide a reason..." required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal"><i
                                class="fas fa-arrow-left"></i> Close</button>
                        <button type="button" class="btn btn-danger" id="confirmCancelItem"><i
                                class="fas fa-paper-plane"></i> Request Cancellation</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Return Reason Modal -->
        <div class="modal fade" id="returnItemModal" tabindex="-1" role="dialog" aria-labelledby="returnItemModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-white">
                        <h5 class="modal-title" id="returnItemModalLabel"><i class="fas fa-undo-alt"></i> Return Item
                        </h5>
                        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="returnItemForm">
                            <div class="form-group">
                                <label for="returnReason" class="font-weight-bold">Reason for return:</label>
                                <textarea class="form-control border-warning" id="returnReason" rows="4"
                                    placeholder="Please provide a reason..." required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal"><i
                                class="fas fa-arrow-left"></i> Close</button>
                        <button type="button" class="btn btn-warning" id="confirmReturnItem"><i
                                class="fas fa-paper-plane"></i> Request Return</button>
                    </div>
                </div>
            </div>
        </div>
        <style>
            .form-group {
                margin-bottom: 2rem;
                width: 540px;
                margin-left: 15px;
            }

            .modal-content {
                width: 775px;
            }

            .modal-dialog {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: calc(100% - 1rem);
            }
        </style>

<footer class="footer footer-2">
    <div class="footer-middle">
        <div class="container">
            <div class="row">
                <div class="col-sm-12 col-lg-6">
                    <div class="widget widget-about">

                        <p>Thanks for visiting Wrist Wise, where you can find a wide range of stylish
                            and high-quality watches for every occasion. Whether you're looking for a sleek,
                            modern design or a classic timepiece, we've got something for everyone. Our watches
                            are priced affordably, making them accessible to all, without compromising on
                            quality. Browse through our
                            collection today and find the perfect watch to match your style!</p>

                        <div class="widget-about-info">
                            <div class="row">
                                <div class="col-sm-6 col-md-4">
                                    <span class="widget-about-title">Got Question? Call us 24/7</span>
                                    <a href="tel:123456789">+91 8086 86 2233</a>
                                </div><!-- End .col-sm-6 -->

                            </div><!-- End .row -->
                        </div><!-- End .widget-about-info -->
                    </div><!-- End .widget about-widget -->
                </div><!-- End .col-sm-12 col-lg-3 -->

                <div class="col-sm-4 col-lg-2">
                    <div class="widget">
                        <h4 class="widget-title">Information</h4><!-- End .widget-title -->

                        <ul class="widget-list">
                            <li><a href="/aboutus">About Us</a></li>
                            <li><a href="/aboutus">Who we are</a></li>
                            <li><a href="/aboutus">FAQ</a></li>
                            <li><a href="/aboutus">Contact us</a></li>
                            <li><a href="/login">Log in</a></li>
                        </ul><!-- End .widget-list -->
                    </div><!-- End .widget -->
                </div><!-- End .col-sm-4 col-lg-3 -->

                <div class="col-sm-4 col-lg-2">
                    <div class="widget">
                        <h4 class="widget-title">Customer Service</h4><!-- End .widget-title -->

                        <ul class="widget-list">
                            <li><a href="/aboutus">Payment Methods</a></li>
                            <li><a href="/aboutus">Money-back guarantee!</a></li>
                            <li><a href="/aboutus">Returns</a></li>
                            <li><a href="/aboutus">Shipping</a></li>
                            <li><a href="/aboutus">Terms and conditions</a></li>
                            <li><a href="/aboutus">Privacy Policy</a></li>
                        </ul><!-- End .widget-list -->
                    </div><!-- End .widget -->
                </div><!-- End .col-sm-4 col-lg-3 -->

                <div class="col-sm-4 col-lg-2">
                    <div class="widget">
                        <h4 class="widget-title">My Account</h4><!-- End .widget-title -->

                        <ul class="widget-list">
                            <li><a href="/login">Sign In</a></li>
                            <li><a href="/cart">View Cart</a></li>
                            <li><a href="/wishlist">My Wishlist</a></li>
                            <li><a href="/profileOrders">Track My Order</a></li>
                            <li><a href="/aboutus">Contact Us</a></li>
                        </ul><!-- End .widget-list -->
                    </div><!-- End .widget -->
                </div><!-- End .col-sm-64 col-lg-3 -->
            </div><!-- End .row -->
        </div><!-- End .container -->
    </div><!-- End .footer-middle -->

    <div class="footer-bottom">
        <div class="container">
            <p class="footer-copyright">Copyright © 2024 Wrist Wise. All Rights Reserved.</p>


            <div class="social-icons social-icons-color">
                <span class="social-label">Social Media</span>

                <a href="http://Wa.me/+918086862233" class="social-icon social-whatsapp" title="WhatsApp"
                    target="_blank"><i class="icon-whatsapp"></i></a>
                <a href="https://www.instagram.com/rishhaadh?igsh=MTZzZjh0dnQ2Yzl4eA%3D%3D&utm_source=qr"
                    class="social-icon social-instagram" title="Instagram" target="_blank"><i
                        class="icon-instagram"></i></a>


            </div><!-- End .soial-icons -->
        </div><!-- End .container -->
    </div><!-- End .footer-bottom -->
</footer><!-- End .footer -->

    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>

        $(document).ready(function () {
            let currentOrderId, currentItemId;

            $(document).on('click', '.view-order-btn', function () {
                const orderId = $(this).data('order-id');
                const modalBody = $('#orderModal .modal-body');

                modalBody.empty();
                modalBody.html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');

                $.ajax({
                    url: `/user/order-details/${orderId}`,
                    method: 'GET',
                    success: function (order) {
                        const content = `
                    <div class="row mb-4">
                        <!-- Shipping Address and Order Summary -->
                        <div class="col-md-6 mb-3">
                            <div class="card order-card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="icon-map-marker"></i> Shipping Address</h5>
                                    <p class="card-text">
                                        <strong>${order.address.addressName}</strong><br>
                                        ${order.address.addressStreet}<br>
                                        ${order.address.addressHouse}<br>
                                        ${order.address.addressCity}, ${order.address.addressState} ${order.address.addressPin}<br>
                                        <strong>Phone:</strong> ${order.address.addressMobile}<br>
                                        <strong>Email:</strong> ${order.address.addressEmail}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card order-card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="icon-info-circle"></i> Order Summary</h5>
                                    <p class="card-text">
                                        <strong>Order ID:</strong> ${order.orderId}<br>
                                        <strong>Order Date:</strong> ${new Date(order.createdAt).toLocaleDateString()}<br>
                                        <strong>Payment Method:</strong> ${order.paymentMethod}<br>
                                        <strong>Total Amount:</strong> ₹${order.totalPrice.toFixed(2)}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Invoice Table -->
                    <div class="card mb-4 invoice-card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="icon-file-text"></i> Invoice</h5>
                            <div class="table-responsive">
                                <table class="table table-invoice">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th class="text-center">Quantity</th>
                                            <th class="text-right">Price</th>
                                            <th class="text-right">Subtotal</th>
                                            <th class="text-center">Status</th>
                                            <th class="text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${order.items.map(item => `
                                            <tr data-item-id="${item._id}">
                                                <td>${item.product.productTitle}</td>
                                                <td class="text-center">${item.quantity}</td>
                                                <td class="text-right">₹${item.price.toFixed(2)}</td>
                                                <td class="text-right">₹${(item.price * item.quantity).toFixed(2)}</td>
                                                <td class="text-center">
                                                    <span class="badge badge-${item.order_status === 'Payment Failed' ? 'danger' : 'primary'}">${item.order_status}</span>
                                                </td>
                                                <td class="text-center">
                                                    ${item.order_status === 'Payment Failed' ? `
                                                        <button type="button" class="btn btn-warning btn-sm retry-payment-btn"
                                                            data-order-id="${order._id}" data-item-id="${item._id}">
                                                            Retry Payment
                                                        </button>` :
                                item.order_status !== 'Cancelled' && item.order_status !== 'Delivered' && item.order_status !== 'Cancellation Requested' ? `
                                                        <button type="button" class="btn btn-danger btn-sm cancel-item-btn"
                                                            data-order-id="${order._id}" data-item-id="${item._id}">
                                                            Cancel
                                                        </button>` :
                                    item.order_status === 'Delivered' ? `
                                                        <button type="button" class="btn btn-warning btn-sm return-item-btn"
                                                            data-order-id="${order._id}" data-item-id="${item._id}">
                                                            Return
                                                        </button>` : ''}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="3" class="text-right"><strong>Subtotal:</strong></td>
                                            <td class="text-right">₹${order.totalPrice.toFixed(2)}</td>
                                            <td colspan="2"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-right"><strong>Shipping:</strong></td>
                                            <td class="text-right">Free</td>
                                            <td colspan="2"></td>
                                        </tr>
                                        <tr class="total-row">
                                            <td colspan="3" class="text-right"><strong>Total:</strong></td>
                                            <td class="text-right"><strong>₹${order.totalPrice.toFixed(2)}</strong></td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                        modalBody.html(content);
                        $('#orderModal').modal('show');
                    },
                    error: function () {
                        modalBody.html('<div class="alert alert-danger">Error loading order details.</div>');
                    }
                });
            });

            $(document).on('click', '.retry-payment-btn', function () {
                currentOrderId = $(this).data('order-id');
                initiateRazorpayPayment(currentOrderId);
            });

            function initiateRazorpayPayment(orderId) {
                $.ajax({
                    url: `/user/retry-razorpay-payment/${orderId}`,
                    method: 'POST',
                    success: function (data) {
                        if (data.success) {
                            const options = {
                                key: data.razorpayKeyId,
                                amount: data.order.amount,
                                currency: data.order.currency,
                                name: 'Your Company Name',
                                description: 'Order Payment',
                                order_id: data.order.id,
                                handler: function (response) {
                                    verifyPayment(orderId, response.razorpay_payment_id, response.razorpay_order_id, response.razorpay_signature);
                                },
                                prefill: {
                                    name: data.user.name,
                                    email: data.user.email,
                                    contact: data.user.phone
                                },
                                theme: {
                                    color: '#3399cc'
                                }
                            };
                            const rzp = new Razorpay(options);
                            rzp.open();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Payment Error',
                                text: data.message || 'Error initiating payment'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Payment Error',
                            text: 'Error initiating payment. Please try again.'
                        });
                    }
                });
            }

            function verifyPayment(orderId, paymentId, razorpayOrderId, signature) {
                $.ajax({
                    url: `/user/verify-razorpay-payment`,
                    method: 'POST',
                    data: {
                        orderId: orderId,
                        paymentId: paymentId,
                        razorpayOrderId: razorpayOrderId,
                        signature: signature
                    },
                    success: function (response) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Payment Successful',
                            text: response.message
                        }).then(() => {
                            $('#orderModal').modal('hide');
                            location.reload(); 
                        });
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Verification Error',
                            text: 'Error verifying payment. Please try again.'
                        });
                    }
                });
            }
            $(document).on('click', '.cancel-item-btn', function () {
                currentItemId = $(this).data('item-id');
                currentOrderId = $(this).data('order-id');
                $('#cancelItemModal').modal('show');
            });

            $(document).on('click', '.return-item-btn', function () {
                currentItemId = $(this).data('item-id');
                currentOrderId = $(this).data('order-id');
                $('#returnItemModal').modal('show');
            });

            $('#confirmCancelItem').on('click', function () {
                const reason = $('#cancelReason').val().trim();
                if (reason === '') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Cancellation Error',
                        text: 'Please provide a reason for cancellation.'
                    });
                    return;
                }

                $.ajax({
                    url: `/user/cancel-item/${currentOrderId}/${currentItemId}`,
                    method: 'POST',
                    data: { reason: reason },
                    success: function (response) {
                        $('#cancelItemModal').modal('hide');
                        updateItemStatus(currentItemId, 'Cancellation Requested');
                        Swal.fire({
                            icon: 'success',
                            title: 'Cancellation Requested',
                            text: response.message
                        });
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Cancellation Error',
                            text: 'Error cancelling item. Please try again.'
                        });
                    }
                });
            });

            $('#confirmReturnItem').on('click', function () {
                const reason = $('#returnReason').val().trim();
                if (reason === '') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Return Error',
                        text: 'Please provide a reason for returning the item.'
                    });
                    return;
                }

                $.ajax({
                    url: `/user/return-item/${currentOrderId}/${currentItemId}`,
                    method: 'POST',
                    data: { reason: reason },
                    success: function (response) {
                        $('#returnItemModal').modal('hide');
                        updateItemStatus(currentItemId, 'Return Requested');
                        Swal.fire({
                            icon: 'success',
                            title: 'Return Requested',
                            text: response.message
                        });
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Return Error',
                            text: 'Error returning item. Please try again.'
                        });
                    }
                });
            });

            function updateItemStatus(itemId, status) {
                const itemRow = $(`[data-item-id="${itemId}"]`);
                itemRow.find('.badge').text(status).removeClass().addClass(`badge badge-${status === 'Cancellation Requested' ? 'warning' : 'danger'}`);
                itemRow.find('.cancel-item-btn').prop('disabled', true);
                itemRow.find('.return-item-btn').prop('disabled', true);
            }
        });


    </script>

<!-- Logout  js -->
<script>
    document.getElementById('logoutLink').addEventListener('click', function (e) {
        e.preventDefault();

        Swal.fire({
            title: 'Ready to leave?',
            text: "You're about to sign out of your account.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes I Will',
            cancelButtonText: 'Cancel',
            customClass: {
                container: 'my-swal'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/logout', {
                    method: 'POST',
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (response.ok) {
                            Swal.fire({
                                title: 'Signed Out!',
                                text: 'You have been successfully logged out.',
                                icon: 'success',
                                confirmButtonColor: '#3085d6'
                            }).then(() => {
                                window.location.href = '/';
                            });
                        } else {
                            throw new Error('Logout failed');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Oops...',
                            text: 'Failed to sign out. Please try again.',
                            icon: 'error',
                            confirmButtonColor: '#3085d6'
                        });
                    });
            }
        });
    });
</script>
    <!-- Plugins JS File -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/jquery.hoverIntent.min.js"></script>
    <script src="assets/js/jquery.waypoints.min.js"></script>
    <script src="assets/js/superfish.min.js"></script>
    <script src="assets/js/owl.carousel.min.js"></script>
    <!-- Main JS File -->
    <script src="assets/js/main.js"></script>


    <%- include ('../layouts/footer.ejs') %>