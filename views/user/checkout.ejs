<%- include ('../layouts/header.ejs') %>

    <!-- Adress card style -->
    <style>
        .card-address {
            border: 1px solid #dbc9c9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }

        .card-address .card-body {
            padding: 0;
        }

        .custom-control-label {
            font-weight: 500;
        }
    </style>

    <!-- add address modal -->
    <style>
        #addAddressModal .modal-content {
            border-radius: 0.5rem;
        }

        #addAddressModal .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 1.5rem;
        }

        #addAddressModal .modal-body {
            padding: 1.5rem;
        }

        #addAddressModal .modal-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 1rem 1.5rem;
        }

        #addAddressModal .form-control {
            border-radius: 0.25rem;
        }

        #addAddressModal label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        #addAddressModal .btn {
            border-radius: 0.25rem;
        }

        #addAddressModal .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        #addAddressModal .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        #addAddressModal .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        #addAddressModal .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
    </style>

    <!-- coupon -->



    <style>
        .coupon-container {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .coupon-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #333;
        }

        .coupon-form .input-group {
            display: flex;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .coupon-input {
            flex-grow: 1;
            border: 1px solid #ced4da;
            border-right: none;
            padding: 8px 12px;
            font-size: 1rem;
            height: 36px;
            /* Set a fixed height to match buttons */
        }

        .coupon-input::placeholder {
            font-size: 0.9rem;
            letter-spacing: 1px;
            color: #000000;
        }

        .input-group-append {
            display: flex;
        }

        .btn {
            padding: 4px 8px;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            height: 36px;
            /* Match height with input */
            white-space: nowrap;
        }

        .btn-show-coupon {
            background-color: #b84a4a;
            color: white;
        }

        .btn-apply-coupon {
            background-color: #3e6747;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .icon-tag,
        .icon-check {
            margin-right: 3px;
            font-size: 0.7rem;
        }
    </style>

    <div class="page-wrapper">
        <header class="header">

            <div class="header-top">
                <div class="container">
                    <div class="header-left col-lg-7">
                        <nav aria-label="breadcrumb" class="breadcrumb-nav border-0 mb-0">
                            <div class="container breadcrumbs">
                                <ol class="breadcrumb">
                                    <!-- Breadcrumbs with links -->
                                    <li class="breadcrumb-item">
                                        <% if (user) { %>
                                    <li>
                                        <a href="userprofile"><i class="icon-user"></i>
                                            <%= user.name || user.displayName %>
                                        </a>
                                    </li>
                                    <% } else { %>
                                        <li>
                                            <a href="/login"><i class="icon-user"></i>Login</a>
                                        </li>
                                        <% } %>
                                            </li>


                                </ol>
                            </div>
                            <!-- End .container -->
                        </nav>
                        <!-- End .breadcrumb-nav -->
                    </div>

                    <!-- End .header-right -->
                </div>
                <!-- End .container -->

            </div>
            <div class="header-bottom sticky-header">
                <div class="container">
                    <div class="header-left">
                        <button class="mobile-menu-toggler">
                            <span class="sr-only">Toggle mobile menu</span>
                            <i class="icon-bars"></i>
                        </button>

                        <img src="/images/ww logo black.jpg" alt="Molla Logo"
                            style="width:72px; height:62px; cursor:pointer;">

                    </div>
                    <div class="header-center">
                        <nav class="main-nav">
                            <ul class="menu sf-arrows">
                                <li class="megamenu-container ">
                                    <a href="home" class="sf-with-ul">Home</a>

                                </li>
                                <li class="megamenu-container active">
                                    <a href="category" class="sf-with-ul ">Shoping</a>
                                </li>

                                <li>
                                    <a href="#" class="sf-with-ul">Pages</a>

                                    <ul>
                                        <li>
                                            <a href="/aboutus">About Us</a>

                                        </li>
                                        <li>
                                            <a href="/aboutus">Contact Us</a>

                                        </li>
                                        <li><a href="/category">Shoping</a></li>
                                        <li><a href="/userprofile">My Account</a></li>
                                        <li><a href="/profileOrders">My Orders</a></li>
                                        <li><a href="/wallet">My Wallet</a></li>

                                        <li><a href="/cart">Cart</a></li>
                                        <li><a href="/wishlist">Wishlist</a></li>
                                        <li><a href="/login">Login</a></li>
                                    </ul>
                                </li>
                            </ul><!-- End .menu -->
                        </nav><!-- End .main-nav -->
                    </div><!-- End .header-left -->

                    <div class="header-right">


                        <a href="wishlist" class="wishlist-link">
                            <i class="icon-heart-o"></i>

                        </a>

                        <div class="dropdown cart-dropdown">
                            <a href="/cart" class="dropdown-toggle" role="button">
                                <i class="icon-shopping-cart"></i>
                            </a>
                        </div>
                    </div><!-- End .header-right -->
                </div><!-- End .container -->
            </div><!-- End .header-bottom -->
        </header><!-- End .header -->

        <main class="main">
            <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
                <div class="container">
                    <h1 class="page-title">Checkout<span>Shop</span></h1>
                </div><!-- End .container -->
            </div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/home">Home</a></li>
                        <li class="breadcrumb-item"><a href="/cart">Cart</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
                <div class="checkout">

                    <div class="container">
                        <form id="orderForm">
                            <div class="row">
                                <div class="col-lg-9">

                                    <div class="coupon-container">
                                        <h4 class="coupon-title">Have a Coupon</h4>
                                        <form action="#" class="coupon-form">
                                            <div class="input-group">
                                                <input type="text" class="form-control coupon-input" required
                                                    placeholder="COUPON CODE">
                                                <div class="input-group-append">
                                                    <button class="btn btn-show-coupon" type="button"
                                                        id="showCouponBtn">
                                                        <i class="icon-tag"></i> Show
                                                    </button>
                                                    <button class="btn btn-apply-coupon" type="button" id="applyBtn">
                                                        <i class="icon-check"></i> Apply
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>

                                    <h2 class="checkout-title">Billing Details</h2>
                                    <% if (addresses && addresses.length> 0) { %>
                                        <% addresses.forEach((address, index)=> { %>
                                            <div class="card card-address">
                                                <div class="card-body">
                                                    <p>
                                                        Full Name: <%= address.fullName %><br>
                                                            Street Address: <%= address.streetAddress %><br>
                                                                Apartment Number: <%= address.apartmentNumber %><br>
                                                                    State: <%= address.state %><br>
                                                                        City: <%= address.city %><br>
                                                                            Town: <%= address.town %><br>
                                                                                Pin Code: <%= address.pinCode %><br>
                                                                                    Phone: <%= address.phone %><br>
                                                                                        Email: <%= address.email %><br>
                                                    </p>
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox"
                                                            class="custom-control-input address-checkbox"
                                                            id="address-<%= address._id %>" name="selectedAddress"
                                                            data-address-id="<%= address._id %>">
                                                        <label class="custom-control-label"
                                                            for="address-<%= address._id %>">Select this address</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <% }); %>
                                                <% } else { %>
                                                    <p>No addresses found.</p>

                                                    <% } %>

                                                        <div class="add-address">
                                                            <button type="button" class="btn btn-primary"
                                                                data-toggle="modal" data-target="#addAddressModal">
                                                                Add Address
                                                            </button>
                                                        </div>
                                </div>

                                <aside class="col-lg-3">
                                    <div class="summary">
                                        <h3 class="summary-title">Your Order</h3>

                                        <table class="table table-summary">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <!-- <tbody>
                                                <% cartItems.forEach(item => { %>
                                                <tr class="cart-item">
                                                    <td>Item</td>
                                                    <td class="cart-product-price" data-original-price="<%= item.itemTotal.toFixed(2) %>">₹<%= item.itemTotal.toFixed(2) %></td>
                                                </tr>
                                                <% }); %>
                                                <tr class="summary-coupon">
                                                    <td>Coupon Discount:</td>
                                                    <td>₹<%= couponDiscount %></td>
                                                </tr>
                                                <tr class="summary-subtotal">
                                                    <td>Subtotal:</td>
                                                    <td>₹<%= cartSubtotal %></td>
                                                </tr>
                                                <tr class="summary-shipping">
                                                    <td>Shipping:</td>
                                                    <td>₹<%= shippingCharge %></td>
                                                </tr>
                                                <tr class="summary-total">
                                                    <td>Grand Total:</td>
                                                    <td>₹<%= cartTotal %></td>
                                                </tr>
                                            </tbody> -->
                                            <tbody>
                                                <% cartItems.forEach(item=> { %>
                                                    <tr class="cart-item">
                                                        <td>Item</td>
                                                        <td class="cart-product-price"
                                                            data-original-price="<%= item.itemTotal.toFixed(2) %>">₹<%=
                                                                item.itemTotal.toFixed(2) %>
                                                        </td>
                                                    </tr>
                                                    <% }); %>
                                                        <tr class="summary-subtotal">
                                                            <td>Subtotal:</td>
                                                            <td>₹<%= cartSubtotal %>
                                                            </td>
                                                        </tr>
                                                        <tr class="summary-coupon">
                                                            <td>Coupon Discount:</td>
                                                            <td>₹<%= couponDiscount %>
                                                            </td>
                                                        </tr>
                                                        <tr class="summary-shipping">
                                                            <td>Shipping:</td>
                                                            <td>₹<%= shippingCharge %>
                                                            </td>
                                                        </tr>
                                                        <tr class="summary-total">
                                                            <td>Grand Total:</td>
                                                            <td>₹<%= cartTotal %>
                                                            </td>
                                                        </tr>
                                            </tbody>
                                        </table>
                                        <div class="accordion-summary" id="accordion-payment">

                                            <div class="card-body">
                                                <!-- Cash on Delivery Option -->
                                                <div class="custom-control custom-radio">
                                                    <input type="radio" class="custom-control-input" id="cod"
                                                        name="paymentMethod" value="Cash on Delivery">
                                                    <label class="custom-control-label" for="cod">Cash on
                                                        Delivery</label>
                                                </div>
                                                <!-- Razorpay Option -->
                                                <div class="custom-control custom-radio mt-2">
                                                    <input type="radio" class="custom-control-input" id="razorpay"
                                                        name="paymentMethod" value="Razorpay">
                                                    <label class="custom-control-label" for="razorpay">Razorpay</label>
                                                </div>
                                                <!-- Wallet Payment Option -->
                                                <div class="custom-control custom-radio mt-2">
                                                    <input type="radio" class="custom-control-input" id="wallet"
                                                        name="paymentMethod" value="Wallet">
                                                    <label class="custom-control-label" for="wallet">Wallet
                                                        Payment</label>
                                                </div>
                                            </div>


                                        </div>


                                        <button type="submit"
                                            class="btn btn-outline-primary-2 btn-order btn-block">PLACE ORDER</button>
                                    </div>
                                </aside>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </main>

        <!-- Add Address Modal -->
        <div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-labelledby="addAddressModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addAddressForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fullName">Full Name</label>
                                    <input type="text" class="form-control" id="fullName" name="fullName" required>
                                    <div id="fullNameError" class="text-danger"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                    <div id="emailError" class="text-danger"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="phone">Phone</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" required>
                                    <div id="phoneError" class="text-danger"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="pinCode">Pin Code</label>
                                    <input type="text" class="form-control" id="pinCode" name="pinCode" required>
                                    <div id="pinCodeError" class="text-danger"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="streetAddress">Street Address</label>
                                    <input type="text" class="form-control" id="streetAddress" name="streetAddress"
                                        required>
                                    <div id="streetAddressError" class="text-danger"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="apartmentNumber">Apartment Number</label>
                                    <input type="text" class="form-control" id="apartmentNumber" name="apartmentNumber">
                                    <div id="apartmentNumberError" class="text-danger"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="town">Town</label>
                                    <input type="text" class="form-control" id="town" name="town" required>
                                    <div id="townError" class="text-danger"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="city">City</label>
                                    <input type="text" class="form-control" id="city" name="city" required>
                                    <div id="cityError" class="text-danger"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="state">State</label>
                                    <input type="text" class="form-control" id="state" name="state" required>
                                    <div id="stateError" class="text-danger"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveAddress">Save Address</button>
                    </div>
                </div>
            </div>
        </div>


        <footer class="footer footer-2">
            <div class="footer-middle">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 col-lg-6">
                            <div class="widget widget-about">

                                <p>Thanks for visiting Wrist Wise, where you can find a wide range of stylish
                                    and high-quality watches for every occasion. Whether you're looking for a sleek,
                                    modern design or a classic timepiece, we've got something for everyone. Our watches
                                    are priced affordably, making them accessible to all, without compromising on
                                    quality. Browse through our
                                    collection today and find the perfect watch to match your style!</p>

                                <div class="widget-about-info">
                                    <div class="row">
                                        <div class="col-sm-6 col-md-4">
                                            <span class="widget-about-title">Got Question? Call us 24/7</span>
                                            <a href="tel:123456789">+91 8086 86 2233</a>
                                        </div><!-- End .col-sm-6 -->

                                    </div><!-- End .row -->
                                </div><!-- End .widget-about-info -->
                            </div><!-- End .widget about-widget -->
                        </div><!-- End .col-sm-12 col-lg-3 -->

                        <div class="col-sm-4 col-lg-2">
                            <div class="widget">
                                <h4 class="widget-title">Information</h4><!-- End .widget-title -->

                                <ul class="widget-list">
                                    <li><a href="/aboutus">About Us</a></li>
                                    <li><a href="/aboutus">Who we are</a></li>
                                    <li><a href="/aboutus">FAQ</a></li>
                                    <li><a href="/aboutus">Contact us</a></li>
                                    <li><a href="/login">Log in</a></li>
                                </ul><!-- End .widget-list -->
                            </div><!-- End .widget -->
                        </div><!-- End .col-sm-4 col-lg-3 -->

                        <div class="col-sm-4 col-lg-2">
                            <div class="widget">
                                <h4 class="widget-title">Customer Service</h4><!-- End .widget-title -->

                                <ul class="widget-list">
                                    <li><a href="/aboutus">Payment Methods</a></li>
                                    <li><a href="/aboutus">Money-back guarantee!</a></li>
                                    <li><a href="/aboutus">Returns</a></li>
                                    <li><a href="/aboutus">Shipping</a></li>
                                    <li><a href="/aboutus">Terms and conditions</a></li>
                                    <li><a href="/aboutus">Privacy Policy</a></li>
                                </ul><!-- End .widget-list -->
                            </div><!-- End .widget -->
                        </div><!-- End .col-sm-4 col-lg-3 -->

                        <div class="col-sm-4 col-lg-2">
                            <div class="widget">
                                <h4 class="widget-title">My Account</h4><!-- End .widget-title -->

                                <ul class="widget-list">
                                    <li><a href="/login">Sign In</a></li>
                                    <li><a href="/cart">View Cart</a></li>
                                    <li><a href="/wishlist">My Wishlist</a></li>
                                    <li><a href="/profileOrders">Track My Order</a></li>
                                    <li><a href="/aboutus">Contact Us</a></li>
                                </ul><!-- End .widget-list -->
                            </div><!-- End .widget -->
                        </div><!-- End .col-sm-64 col-lg-3 -->
                    </div><!-- End .row -->
                </div><!-- End .container -->
            </div><!-- End .footer-middle -->

            <div class="footer-bottom">
                <div class="container">
                    <p class="footer-copyright">Copyright © 2024 Wrist Wise. All Rights Reserved.</p>


                    <div class="social-icons social-icons-color">
                        <span class="social-label">Social Media</span>

                        <a href="http://Wa.me/+918086862233" class="social-icon social-whatsapp" title="WhatsApp"
                            target="_blank"><i class="icon-whatsapp"></i></a>
                        <a href="https://www.instagram.com/rishhaadh?igsh=MTZzZjh0dnQ2Yzl4eA%3D%3D&utm_source=qr"
                            class="social-icon social-instagram" title="Instagram" target="_blank"><i
                                class="icon-instagram"></i></a>


                    </div><!-- End .soial-icons -->
                </div><!-- End .container -->
            </div><!-- End .footer-bottom -->
        </footer><!-- End .footer -->

    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>


    <!-- same time only tick on check box -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const checkboxes = document.querySelectorAll('.address-checkbox');
            const handleCheckboxChange = (event) => {
                checkboxes.forEach(checkbox => {
                    if (checkbox !== event.target) {
                        checkbox.checked = false;
                    }
                });
            };
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- validation of add address -->
    <script>
        document.getElementById('saveAddress').addEventListener('click', async () => {
            const form = document.getElementById('addAddressForm');
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const pinCode = document.getElementById('pinCode').value;
            const streetAddress = document.getElementById('streetAddress').value;
            const apartmentNumber = document.getElementById('apartmentNumber').value;
            const town = document.getElementById('town').value;
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;

            let isValid = true;

            if (!/^[a-zA-Z\s]{3,}$/.test(fullName)) {
                document.getElementById('fullNameError').textContent = 'Full name must be at least 3 characters long.';
                isValid = false;
            } else {
                document.getElementById('fullNameError').textContent = '';
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                document.getElementById('emailError').textContent = 'Please enter a valid email address.';
                isValid = false;
            } else {
                document.getElementById('emailError').textContent = '';
            }
            if (!/^\d{10}$/.test(phone)) {
                document.getElementById('phoneError').textContent = 'Phone number must be exactly 10 digits.';
                isValid = false;
            } else {
                document.getElementById('phoneError').textContent = '';
            }
            if (!/^\d{6}$/.test(pinCode)) {
                document.getElementById('pinCodeError').textContent = 'Pin code must be exactly 6 digits.';
                isValid = false;
            } else {
                document.getElementById('pinCodeError').textContent = '';
            }
            if (streetAddress.length < 10) {
                document.getElementById('streetAddressError').textContent = 'Street address must be at least 10 characters long.';
                isValid = false;
            } else {
                document.getElementById('streetAddressError').textContent = '';
            }
            if (apartmentNumber && !/^\d+$/.test(apartmentNumber)) {
                document.getElementById('apartmentNumberError').textContent = 'Apartment number must be a number.';
                isValid = false;
            } else {
                document.getElementById('apartmentNumberError').textContent = '';
            }

            const fields = { town, city, state };
            for (const [key, value] of Object.entries(fields)) {
                if (value.length < 3) {
                    document.getElementById(`${key}Error`).textContent = `${key.charAt(0).toUpperCase() + key.slice(1)} must be at least 3 characters long.`;
                    isValid = false;
                } else {
                    document.getElementById(`${key}Error`).textContent = '';
                }
            }

            if (isValid) {
                const formData = new FormData(form);
                try {
                    const response = await fetch('/add-address', {
                        method: 'POST',
                        body: new URLSearchParams(formData),
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    });
                    const result = await response.json();

                    if (result.success) {
                        window.location.href = window.location.href;
                    } else {
                        console.error(result.error);
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                }
            }
        });
    </script>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const showCouponBtn = document.getElementById('showCouponBtn');
            const applyBtn = document.getElementById('applyBtn');
            const couponInput = document.querySelector('.coupon-input');
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            let appliedCouponCode = null;

            const modal = document.createElement('div');
            modal.className = 'coupon-modal';
            modal.innerHTML = `
        <div class="coupon-modal-content">
            <h4>Available Coupons</h4>
            <div id="couponList"></div>
            <div class="modal-buttons">
                <button id="selectCouponBtn">Select</button>
                <button id="closeCouponModalBtn">Close</button>
            </div>
        </div>
    `;
            document.body.appendChild(modalOverlay);
            document.body.appendChild(modal);

            const couponList = document.getElementById('couponList');
            const selectCouponBtn = document.getElementById('selectCouponBtn');
            const closeCouponModalBtn = document.getElementById('closeCouponModalBtn');

            function showModal() {
                modalOverlay.style.display = 'block';
                modal.style.display = 'block';
            }

            function hideModal() {
                modalOverlay.style.display = 'none';
                modal.style.display = 'none';
            }

            showCouponBtn.addEventListener('click', async function () {
                try {
                    const response = await fetch('/user/active-coupons');
                    const coupons = await response.json();

                    couponList.innerHTML = coupons.map(coupon => `
                <div class="coupon-item">
                    <input type="radio" name="coupon" id="${coupon.couponCode}" value="${coupon.couponCode}">
                    <label for="${coupon.couponCode}">
                        <strong>Code: ${coupon.couponCode}</strong><br>
                        ${coupon.couponName} (${coupon.discount}% off)<br>
                        Min. Amount: ₹${coupon.minAmount}<br>
                        Expires: ${new Date(coupon.expiryDate).toLocaleDateString()}
                    </label>
                </div>
            `).join('');

                    showModal();
                } catch (error) {
                    console.error('Error fetching coupons:', error);
                    alert('Error fetching coupons. Please try again.');
                }
            });

            selectCouponBtn.addEventListener('click', function () {
                const selectedCoupon = document.querySelector('input[name="coupon"]:checked');
                if (selectedCoupon) {
                    couponInput.value = selectedCoupon.value;
                    hideModal();
                } else {
                    alert('Please select a coupon');
                }
            });

            closeCouponModalBtn.addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', hideModal);

            applyBtn.addEventListener('click', async function () {
                const couponCode = couponInput.value;
                const cartTotal = parseFloat(document.querySelector('.summary-total td:last-child').textContent.replace('₹', ''));

                if (!couponCode) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Please enter a coupon code',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                try {
                    const response = await fetch('/user/apply-coupon', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ couponCode, cartTotal }),
                    });

                    const result = await response.json();

                    // if (result.success) {
                    //     updateTotalTable(result.discount, result.discountedTotal);
                    //     alert('Coupon applied successfully!');
                    //     appliedCouponCode = couponCode;
                    // } else {
                    //     alert(`Error: ${result.message}`);
                    // }
                    if (result.success) {
                        updateTotalTable(result.discount, result.discountedTotal);
                        Swal.fire({
                            icon: 'success',
                            title: 'Coupon applied successfully!',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        appliedCouponCode = couponCode;
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: result.message,
                            confirmButtonText: 'OK'
                        });
                    }

                } catch (error) {
                    console.error('Error applying coupon:', error);
                    alert('Error applying coupon. Please try again.');
                }
            });

            function updateTotalTable(discount, discountedTotal) {
                const couponRow = document.querySelector('.summary-coupon td:last-child');
                const totalRow = document.querySelector('.summary-total td:last-child');

                couponRow.textContent = `₹${parseFloat(discount).toFixed(2)}`;
                totalRow.textContent = `₹${parseFloat(discountedTotal).toFixed(2)}`;

                const cartItems = document.querySelectorAll('.cart-item');
                const subtotal = parseFloat(document.querySelector('.summary-subtotal td:last-child').textContent.replace('₹', ''));
                const discountRatio = parseFloat(discount) / subtotal;

                cartItems.forEach(item => {
                    const priceElement = item.querySelector('.cart-product-price');
                    const originalPrice = parseFloat(priceElement.getAttribute('data-original-price'));
                    const discountedPrice = originalPrice * (1 - discountRatio);
                    priceElement.textContent = `₹${discountedPrice.toFixed(2)}`;
                });
            }

            document.querySelector('.btn-order').addEventListener('click', function (e) {
                e.preventDefault();

                const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
                const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
                const totalAmount = parseFloat(document.querySelector('.summary-total td:last-child').textContent.replace('₹', ''));

                if (!selectedAddress) {
                    Swal.fire('Error', 'Please select an address', 'error');
                    return;
                }
                if (!selectedPaymentMethod) {
                    Swal.fire('Error', 'Please select a payment method', 'error');
                    return;
                }

                if (selectedPaymentMethod.value === 'Cash on Delivery' && totalAmount > 2000) {
                    Swal.fire('Error', 'Cash on Delivery is only available for orders below ₹2000. Please choose a different payment method.', 'error');
                    return;
                }

                const orderData = {
                    selectedAddress: selectedAddress.getAttribute('data-address-id'),
                    paymentMethod: selectedPaymentMethod.value,
                    appliedCouponCode: appliedCouponCode
                };

                if (orderData.paymentMethod === 'Razorpay') {
                    initiateRazorpayPayment(orderData);
                } else if (orderData.paymentMethod === 'Wallet') {
                    confirmWalletPayment(orderData);
                } else {
                    placeOrder(orderData);
                }
            });

            function initiateRazorpayPayment(orderData) {
                fetch('/create-razorpay-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...orderData,
                        appliedCouponCode: appliedCouponCode
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const options = {
                                key: '<%= razorpayKeyId %>',
                                amount: data.order.amount,
                                currency: data.order.currency,
                                name: 'Your Company Name',
                                description: 'Purchase Description',
                                order_id: data.order.id,
                                handler: function (response) {
                                    orderData.razorpayOrderId = response.razorpay_order_id;
                                    orderData.razorpayPaymentId = response.razorpay_payment_id;
                                    orderData.razorpaySignature = response.razorpay_signature;
                                    orderData.razorpayPaymentStatus = 'success';
                                    placeOrder(orderData);
                                },
                                prefill: {
                                    name: '<%= user.name %>',
                                    email: '<%= user.email %>',
                                    contact: '<%= user.phone %>'
                                },
                                theme: {
                                    color: '#3399cc'
                                },
                                modal: {
                                    ondismiss: function () {

                                        orderData.razorpayPaymentStatus = 'failed';
                                        placeOrder(orderData);
                                    }
                                }
                            };
                            const rzp = new Razorpay(options);
                            rzp.open();
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'An unexpected error occurred', 'error');
                    });

            }
            function confirmWalletPayment(orderData) {
                const totalAmount = parseFloat(document.querySelector('.summary-total td:last-child').textContent.replace('₹', ''));
                Swal.fire({
                    title: 'Confirm Wallet Payment',
                    text: `Are you sure you want to pay ₹${totalAmount.toFixed(2)} from your wallet?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, pay now',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        placeOrder(orderData);
                    }
                });
            }

            function placeOrder(orderData) {
                fetch('/placeOrder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (data.newWalletBalance !== undefined) {
                                updateWalletBalance(data.newWalletBalance);
                            }
                            if (data.paymentStatus === 'Completed') {
                                Swal.fire('Success', 'Your order was placed successfully!', 'success').then(() => {
                                    window.location.href = `/orderPlaced?orderId=${data.orderId}`;
                                });
                            } else if (data.paymentStatus === 'Pending') {
                                if (orderData.paymentMethod === 'Razorpay') {
                                    Swal.fire({
                                        title: 'Payment Failed',
                                        text: 'Your order has been saved, but the payment was not completed. You can retry the payment from your profile orders.',
                                        icon: 'warning',
                                        confirmButtonText: 'Okay, Show In Profile!'
                                    }).then(() => {
                                        window.location.href = '/profileOrders';
                                    });
                                } else if (orderData.paymentMethod === 'Cash on Delivery') {
                                    Swal.fire('Order Placed', 'Your order has been placed.', 'success').then(() => {
                                        window.location.href = `/orderPlaced?orderId=${data.orderId}`;
                                    });
                                } else {
                                    Swal.fire('Order Placed', 'Your order has been placed but payment is pending.', 'info').then(() => {
                                        window.location.href = `/orderPlaced?orderId=${data.orderId}`;
                                    });
                                }
                            }
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'An unexpected error occurred', 'error');
                    });
            }
            function updateWalletBalance(newBalance) {
                const walletBalanceElement = document.querySelector('.wallet-balance');
                if (walletBalanceElement) {
                    walletBalanceElement.textContent = `₹ ${newBalance.toFixed(2)}`;
                }
            }
        });
    </script>


    <style>
        .coupon-container {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .coupon-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #333;
        }

        .coupon-form .input-group {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .coupon-input {
            border: 1px solid #ced4da;
            border-right: none;
            padding: 10px 15px;
            font-size: 1.4rem;
        }

        .coupon-input::placeholder {
            font-size: 1.2rem;
            letter-spacing: 2px;
            color: #000000;
        }

        .btn {
            padding: 10px 15px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .btn-show-coupon {
            background-color: #b84a4a;
            color: white;
            border: none;
        }

        .btn-apply-coupon {
            background-color: #3e6747;
            color: white;
            border: none;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .icon-tag,
        .icon-check {
            margin-right: 5px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .coupon-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
        }

        .coupon-modal-content {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        #couponList {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .coupon-item {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .coupon-item label {
            display: block;
            margin-left: 25px;
            font-size: 1.1rem;
        }

        .coupon-modal-content h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
        }

        #selectCouponBtn,
        #closeCouponModalBtn {
            margin-left: 10px;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #selectCouponBtn {
            background-color: #3e6747;
            color: white;
        }

        #closeCouponModalBtn {
            background-color: #b84a4a;
            color: white;
        }
    </style>

    <!-- Plugins JS File -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/jquery.hoverIntent.min.js"></script>
    <script src="assets/js/jquery.waypoints.min.js"></script>
    <script src="assets/js/superfish.min.js"></script>
    <script src="assets/js/owl.carousel.min.js"></script>
    <!-- Main JS File -->
    <script src="assets/js/main.js"></script>


    <%- include ('../layouts/footer.ejs') %>